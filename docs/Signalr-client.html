<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>SignalR Chat Client</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; }
    h1 { margin-bottom: 8px; }
    .box { max-width: 640px; }
    .row { display: flex; gap: 8px; margin-bottom: 8px; }
    input, button { padding: 8px; }
    input { flex: 1; }
    #log { border: 1px solid #ddd; padding: 8px; height: 260px; overflow: auto; background: #fafafa; }
    .msg { margin-bottom: 6px; }
    .sys { color: #888; }
  </style>
</head>
<body>
  <div class="box">
    <h1>SignalR Chat Demo</h1>
    <p class="sys">连接到 <code>/hub/chat</code>，演示最基础的消息广播。</p>

    <div class="row">
      <input id="user" placeholder="用户名（如：Alice）" />
      <button id="connect">连接</button>
      <button id="disconnect" disabled>断开</button>
    </div>

    <div class="row">
      <input id="message" placeholder="输入消息" />
      <button id="send" disabled>发送</button>
    </div>

    <div id="log"></div>
  </div>

  <!-- SignalR 客户端库（CDN） -->
  <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>
	<script>
	  const log = document.getElementById("log");
	  const connectBtn = document.getElementById("connect");
	  const disconnectBtn = document.getElementById("disconnect");
	  const sendBtn = document.getElementById("send");

	  let connection = null;
	  let token = "";

	  function writeLog(text, cls = "") {
		const div = document.createElement("div");
		div.className = `msg ${cls}`;
		div.innerText = text;
		log.appendChild(div);
		log.scrollTop = log.scrollHeight;
	  }

	  async function login(username) {
		const res = await fetch("https://localhost:7150/api/auth/login", {
		  method: "POST",
		  headers: { "Content-Type": "application/json" },
		  body: JSON.stringify({
			username: "admin",
			password: "123456"
		  })
		});

		if (!res.ok) {
		  throw new Error("登录失败");
		}

		const data = await res.json();
		return data.token;
	  }

	  async function connect() {
		try {
		  writeLog("正在登录...", "sys");

		  token = await login();
		  writeLog("登录成功，获取到 Token", "sys");

		  connection = new signalR.HubConnectionBuilder()
			.withUrl("https://localhost:7150/hub/chat", {
			  accessTokenFactory: () => token
			})
			.withAutomaticReconnect()
			.build();

		  connection.on("ReceiveMessage", (user, message) => {
			writeLog(`${user}: ${message}`);
		  });

		  await connection.start();

		  writeLog("已连接到 SignalR Hub", "sys");

		  connectBtn.disabled = true;
		  disconnectBtn.disabled = false;
		  sendBtn.disabled = false;
		} catch (err) {
		  console.error(err);
		  writeLog("连接失败：" + err.message, "sys");
		}
	  }

	  async function disconnect() {
		if (connection) {
		  await connection.stop();
		  writeLog("已断开连接", "sys");
		}
		connectBtn.disabled = false;
		disconnectBtn.disabled = true;
		sendBtn.disabled = true;
	  }

	  async function sendMessage() {
		const msg = document.getElementById("message").value;
		if (!msg) return;

		await connection.invoke("SendMessage", "admin", msg);
		document.getElementById("message").value = "";
	  }

	  connectBtn.onclick = connect;
	  disconnectBtn.onclick = disconnect;
	  sendBtn.onclick = sendMessage;
	</script>


</body>
</html>
